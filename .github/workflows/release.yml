name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g., 0.45.1 or 0.45.1-swift.2)"
        required: true
      rebuild:
        description: "Rebuild libraries before release"
        type: boolean
        default: false

permissions:
  contents: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # Build macOS libraries on macOS runner
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    if: ${{ github.event.inputs.rebuild == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          lfs: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Extract resvg version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          RESVG_VERSION="${VERSION%%-swift.*}"
          echo "RESVG_VERSION=$RESVG_VERSION" >> "$GITHUB_ENV"

      - name: Build macOS libraries
        run: ./Scripts/build.sh "${{ env.RESVG_VERSION }}" --macos

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-universal
          path: resvg.artifactbundle/macos-universal/libresvg.a

  # Build Linux libraries on Linux runner
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.rebuild == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          lfs: true

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Extract resvg version
        run: |
          VERSION="${{ github.event.inputs.version }}"
          RESVG_VERSION="${VERSION%%-swift.*}"
          echo "RESVG_VERSION=$RESVG_VERSION" >> "$GITHUB_ENV"

      - name: Build Linux libraries
        run: ./Scripts/build.sh "${{ env.RESVG_VERSION }}" --linux

      - name: Upload Linux x86_64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-x86_64
          path: resvg.artifactbundle/linux-x86_64/libresvg.a

      - name: Upload Linux aarch64 artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-aarch64
          path: resvg.artifactbundle/linux-aarch64/libresvg.a

      - name: Upload header
        uses: actions/upload-artifact@v4
        with:
          name: include
          path: resvg.artifactbundle/include/

  # Create release (runs after builds or immediately if no rebuild)
  release:
    name: Create Release
    runs-on: macos-latest
    needs: [build-macos, build-linux]
    if: always() && (github.event.inputs.rebuild != 'true' || (needs.build-macos.result == 'success' && needs.build-linux.result == 'success'))
    steps:
      - name: Checkout main
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0
          lfs: true

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ "$VERSION" == v* ]]; then
            echo "Error: Version should not start with 'v'. Use format: 0.45.1 or 0.45.1-swift.2"
            exit 1
          fi
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-swift\.[0-9]+)?$ ]]; then
            echo "Error: Version must follow format: major.minor.patch or major.minor.patch-swift.N"
            exit 1
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          RESVG_VERSION="${VERSION%%-swift.*}"
          echo "RESVG_VERSION=$RESVG_VERSION" >> "$GITHUB_ENV"

      - name: Download macOS artifact
        if: ${{ github.event.inputs.rebuild == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: macos-universal
          path: resvg.artifactbundle/macos-universal/

      - name: Download Linux x86_64 artifact
        if: ${{ github.event.inputs.rebuild == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: linux-x86_64
          path: resvg.artifactbundle/linux-x86_64/

      - name: Download Linux aarch64 artifact
        if: ${{ github.event.inputs.rebuild == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: linux-aarch64
          path: resvg.artifactbundle/linux-aarch64/

      - name: Download headers
        if: ${{ github.event.inputs.rebuild == 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: include
          path: resvg.artifactbundle/include/

      - name: Validate artifact bundle
        run: |
          echo "Validating artifact bundle..."
          for platform in macos-universal linux-x86_64 linux-aarch64; do
            lib="resvg.artifactbundle/$platform/libresvg.a"
            if [ ! -f "$lib" ]; then
              echo "ERROR: Missing $lib"
              exit 1
            fi
            size=$(stat -f%z "$lib" 2>/dev/null || stat -c%s "$lib" 2>/dev/null || wc -c < "$lib")
            if [ "$size" -lt 1000000 ]; then
              echo "ERROR: $lib seems too small ($size bytes)"
              exit 1
            fi
            echo "âœ“ $platform: $((size/1024/1024))MB"
          done
          echo "Artifact bundle validated successfully"

      - name: Create artifact bundle zip
        run: |
          zip -r resvg.artifactbundle.zip resvg.artifactbundle
          CHECKSUM=$(shasum -a 256 resvg.artifactbundle.zip | cut -d' ' -f1)
          echo "CHECKSUM=${CHECKSUM}" >> "$GITHUB_ENV"
          echo "Checksum: ${CHECKSUM}"

      - name: Setup git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Setup release branch
        run: |
          # Save downloaded artifacts before switching branches
          if [ -d "resvg.artifactbundle" ]; then
            mv resvg.artifactbundle /tmp/artifacts
          fi
          git fetch origin release/artifact-bundle
          git checkout release/artifact-bundle
          # Restore artifacts (overwrite whatever was on the branch)
          if [ -d "/tmp/artifacts" ]; then
            rm -rf resvg.artifactbundle
            mv /tmp/artifacts resvg.artifactbundle
          fi
          git checkout main -- Sources/Resvg/

      - name: Update Package.swift on release branch
        run: |
          sed -i '' "s|releases/download/v[^/]*/|releases/download/v${{ env.VERSION }}/|g" Package.swift
          sed -i '' "s|checksum: \"[^\"]*\"|checksum: \"${{ env.CHECKSUM }}\"|g" Package.swift
          cat Package.swift

      - name: Commit and push release branch
        run: |
          git add Package.swift Sources/
          git diff --staged --quiet || git commit -m "chore(release): v${{ env.VERSION }}"
          git push origin release/artifact-bundle

      - name: Create and push tag
        run: |
          git tag "v${{ env.VERSION }}"
          git push origin "v${{ env.VERSION }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          files: resvg.artifactbundle.zip
          body: |
            ## swift-resvg v${{ env.VERSION }}

            Swift bindings for [resvg](https://github.com/RazrFalcon/resvg) v${{ env.RESVG_VERSION }}.

            ### Installation

            ```swift
            .package(url: "https://github.com/alexey1312/swift-resvg.git", from: "${{ env.VERSION }}")
            ```

            ### Artifact Bundle

            **Checksum (SHA256):** `${{ env.CHECKSUM }}`

            ### Bundled Libraries

            | Platform | Architecture | Size |
            |----------|-------------|------|
            | macOS | arm64 + x86_64 (universal) | ~43 MB |
            | Linux | x86_64 | ~28 MB |
            | Linux | aarch64 | ~29 MB |

      - name: Update main branch
        run: |
          # Remove artifact bundle before switching (zip already created)
          rm -rf resvg.artifactbundle/
          git checkout main
          sed -i '' "s|releases/download/v[^/]*/|releases/download/v${{ env.VERSION }}/|g" Package.swift
          sed -i '' "s|checksum: \"[^\"]*\"|checksum: \"${{ env.CHECKSUM }}\"|g" Package.swift
          git add Package.swift
          if ! git diff --staged --quiet; then
            git commit -m "chore: update Package.swift to v${{ env.VERSION }}"
            git push origin main
          fi
