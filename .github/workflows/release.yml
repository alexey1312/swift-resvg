name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (e.g., 0.45.1 or 0.45.1-swift.2)"
        required: true

permissions:
  contents: write

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main
        uses: actions/checkout@v6
        with:
          ref: main
          fetch-depth: 0

      - name: Validate version format
        run: |
          VERSION="${{ github.event.inputs.version }}"
          if [[ $VERSION == v* ]]; then
            echo "Error: Version should not start with 'v'. Use format: 0.45.1 or 0.45.1-swift.2"
            exit 1
          fi
          if ! [[ $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+(-swift\.[0-9]+)?$ ]]; then
            echo "Error: Version must follow format: major.minor.patch or major.minor.patch-swift.N"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          # Extract base resvg version (without -swift.N suffix)
          RESVG_VERSION=$(echo "$VERSION" | sed 's/-swift\.[0-9]*$//')
          echo "RESVG_VERSION=$RESVG_VERSION" >> $GITHUB_ENV

      - name: Create artifact bundle zip
        run: |
          zip -r resvg.artifactbundle.zip resvg.artifactbundle
          CHECKSUM=$(sha256sum resvg.artifactbundle.zip | cut -d' ' -f1)
          echo "CHECKSUM=${CHECKSUM}" >> $GITHUB_ENV
          echo "Checksum: ${CHECKSUM}"

      - name: Setup release branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch and checkout release branch
          git fetch origin release/artifact-bundle
          git checkout release/artifact-bundle

          # Copy Swift sources from main (in case they changed)
          git checkout main -- Sources/Resvg/

      - name: Update Package.swift
        run: |
          sed -i "s|releases/download/v[^/]*/|releases/download/v${{ env.VERSION }}/|g" Package.swift
          sed -i "s|checksum: \"[^\"]*\"|checksum: \"${{ env.CHECKSUM }}\"|g" Package.swift
          cat Package.swift

      - name: Commit and push release branch
        run: |
          git add Package.swift Sources/
          git diff --staged --quiet || git commit -m "chore(release): v${{ env.VERSION }}"
          git push origin release/artifact-bundle

      - name: Create and push tag
        run: |
          git tag "v${{ env.VERSION }}"
          git push origin "v${{ env.VERSION }}"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          files: resvg.artifactbundle.zip
          body: |
            ## swift-resvg v${{ env.VERSION }}

            Swift bindings for [resvg](https://github.com/RazrFalcon/resvg) v${{ env.RESVG_VERSION }}.

            ### Installation

            ```swift
            .package(url: "https://github.com/alexey1312/swift-resvg.git", from: "${{ env.VERSION }}")
            ```

            ### Artifact Bundle

            **Checksum (SHA256):** `${{ env.CHECKSUM }}`

            ### Bundled Libraries

            | Platform | Architecture | Size |
            |----------|-------------|------|
            | macOS | arm64 + x86_64 (universal) | ~43 MB |
            | Linux | x86_64 | ~28 MB |
            | Linux | aarch64 | ~29 MB |
